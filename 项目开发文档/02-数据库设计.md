# 云盘系统开发文档 - 数据库设计

## 1. 数据库设计原则

- 遵循三范式，减少数据冗余
- 合理使用索引，提升查询性能
- 使用逻辑删除，保留数据历史
- 字段命名规范，统一使用下划线命名
- 时间字段统一使用 DATETIME 类型
- 必要字段添加注释

## 2. 数据库表设计

### 2.1 用户表 (sys_user)

```sql
CREATE TABLE `sys_user` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(100) NOT NULL COMMENT '密码（加密）',
  `nickname` VARCHAR(50) DEFAULT NULL COMMENT '昵称',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `user_type` TINYINT DEFAULT 0 COMMENT '用户类型：0-普通用户，1-管理员',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `storage_quota` BIGINT DEFAULT 10737418240 COMMENT '存储配额（字节），默认10GB',
  `used_storage` BIGINT DEFAULT 0 COMMENT '已使用存储（字节）',
  `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(50) DEFAULT NULL COMMENT '最后登录IP',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` TINYINT DEFAULT 0 COMMENT '逻辑删除：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2.2 文件信息表 (file_info)

```sql
CREATE TABLE `file_info` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '文件ID',
  `file_name` VARCHAR(255) NOT NULL COMMENT '文件名',
  `file_path` VARCHAR(1000) NOT NULL COMMENT '文件路径（相对路径）',
  `file_size` BIGINT NOT NULL DEFAULT 0 COMMENT '文件大小（字节）',
  `file_type` VARCHAR(50) DEFAULT NULL COMMENT '文件类型（扩展名）',
  `content_type` VARCHAR(100) DEFAULT NULL COMMENT 'MIME类型',
  `file_md5` VARCHAR(32) DEFAULT NULL COMMENT '文件MD5值（用于秒传）',
  `storage_type` VARCHAR(20) NOT NULL COMMENT '存储类型：local, oss, cos',
  `storage_path` VARCHAR(1000) DEFAULT NULL COMMENT '实际存储路径',
  `parent_id` BIGINT DEFAULT 0 COMMENT '父文件夹ID，0表示根目录',
  `is_folder` TINYINT DEFAULT 0 COMMENT '是否文件夹：0-否，1-是',
  `user_id` BIGINT NOT NULL COMMENT '所属用户ID',
  `thumbnail_url` VARCHAR(255) DEFAULT NULL COMMENT '缩略图URL（图片/视频）',
  `duration` INT DEFAULT NULL COMMENT '时长（秒，音视频文件）',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-上传中，1-正常，2-损坏',
  `download_count` INT DEFAULT 0 COMMENT '下载次数',
  `is_public` TINYINT DEFAULT 0 COMMENT '是否公开：0-私有，1-公开',
  `password` VARCHAR(20) DEFAULT NULL COMMENT '访问密码',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` TINYINT DEFAULT 0 COMMENT '逻辑删除：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_file_md5` (`file_md5`),
  KEY `idx_file_path` (`file_path`(255)),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_deleted` (`deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件信息表';
```

### 2.3 分享记录表 (file_share)

```sql
CREATE TABLE `file_share` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '分享ID',
  `share_code` VARCHAR(32) NOT NULL COMMENT '分享码（唯一）',
  `file_id` BIGINT NOT NULL COMMENT '文件ID',
  `user_id` BIGINT NOT NULL COMMENT '分享用户ID',
  `share_type` TINYINT DEFAULT 0 COMMENT '分享类型：0-公开，1-密码',
  `share_password` VARCHAR(20) DEFAULT NULL COMMENT '分享密码',
  `expire_time` DATETIME DEFAULT NULL COMMENT '过期时间，NULL表示永久',
  `download_limit` INT DEFAULT 0 COMMENT '下载次数限制，0表示不限制',
  `download_count` INT DEFAULT 0 COMMENT '已下载次数',
  `view_count` INT DEFAULT 0 COMMENT '查看次数',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-已失效，1-有效',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_share_code` (`share_code`),
  KEY `idx_file_id` (`file_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='分享记录表';
```

### 2.4 存储源配置表 (storage_config)

```sql
CREATE TABLE `storage_config` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `storage_name` VARCHAR(50) NOT NULL COMMENT '存储源名称',
  `storage_type` VARCHAR(20) NOT NULL COMMENT '存储类型：local, aliyun_oss, tencent_cos',
  `is_default` TINYINT DEFAULT 0 COMMENT '是否默认：0-否，1-是',
  `endpoint` VARCHAR(255) DEFAULT NULL COMMENT '存储端点',
  `bucket_name` VARCHAR(100) DEFAULT NULL COMMENT '存储桶名称',
  `access_key` VARCHAR(100) DEFAULT NULL COMMENT '访问密钥',
  `secret_key` VARCHAR(255) DEFAULT NULL COMMENT '私密密钥（加密存储）',
  `base_path` VARCHAR(255) DEFAULT NULL COMMENT '基础路径',
  `domain` VARCHAR(255) DEFAULT NULL COMMENT '访问域名',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_storage_type` (`storage_type`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='存储源配置表';
```

### 2.5 文件操作日志表 (file_operation_log)

```sql
CREATE TABLE `file_operation_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` BIGINT NOT NULL COMMENT '操作用户ID',
  `file_id` BIGINT DEFAULT NULL COMMENT '文件ID',
  `operation_type` VARCHAR(20) NOT NULL COMMENT '操作类型：upload, download, delete, rename, move, share',
  `operation_desc` VARCHAR(255) DEFAULT NULL COMMENT '操作描述',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` VARCHAR(255) DEFAULT NULL COMMENT '用户代理',
  `status` TINYINT DEFAULT 1 COMMENT '操作状态：0-失败，1-成功',
  `error_msg` VARCHAR(500) DEFAULT NULL COMMENT '错误信息',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_file_id` (`file_id`),
  KEY `idx_operation_type` (`operation_type`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件操作日志表';
```

### 2.6 回收站表 (file_recycle)

```sql
CREATE TABLE `file_recycle` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '回收ID',
  `file_id` BIGINT NOT NULL COMMENT '文件ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `file_name` VARCHAR(255) NOT NULL COMMENT '文件名',
  `file_path` VARCHAR(1000) NOT NULL COMMENT '原文件路径',
  `file_size` BIGINT NOT NULL COMMENT '文件大小',
  `delete_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '删除时间',
  `expire_time` DATETIME NOT NULL COMMENT '过期时间（30天后自动清理）',
  `status` TINYINT DEFAULT 0 COMMENT '状态：0-回收站，1-已恢复，2-已清空',
  PRIMARY KEY (`id`),
  KEY `idx_file_id` (`file_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_expire_time` (`expire_time`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='回收站表';
```

### 2.7 系统配置表 (sys_config)

```sql
CREATE TABLE `sys_config` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `config_key` VARCHAR(100) NOT NULL COMMENT '配置键',
  `config_value` TEXT COMMENT '配置值',
  `config_type` VARCHAR(20) DEFAULT 'string' COMMENT '配置类型：string, number, boolean, json',
  `config_desc` VARCHAR(255) DEFAULT NULL COMMENT '配置描述',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

### 2.8 用户收藏表 (file_favorite)

```sql
CREATE TABLE `file_favorite` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '收藏ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `file_id` BIGINT NOT NULL COMMENT '文件ID',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '收藏时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_file` (`user_id`, `file_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_file_id` (`file_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户收藏表';
```

### 2.9 文件标签表 (file_tag)

```sql
CREATE TABLE `file_tag` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '标签ID',
  `tag_name` VARCHAR(50) NOT NULL COMMENT '标签名称',
  `tag_color` VARCHAR(20) DEFAULT NULL COMMENT '标签颜色',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件标签表';
```

### 2.10 文件标签关联表 (file_tag_relation)

```sql
CREATE TABLE `file_tag_relation` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '关联ID',
  `file_id` BIGINT NOT NULL COMMENT '文件ID',
  `tag_id` BIGINT NOT NULL COMMENT '标签ID',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_file_tag` (`file_id`, `tag_id`),
  KEY `idx_file_id` (`file_id`),
  KEY `idx_tag_id` (`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件标签关联表';
```

## 3. 初始化数据

### 3.1 管理员账号

```sql
-- 密码为 admin123（需要使用BCrypt加密）
INSERT INTO `sys_user` (`username`, `password`, `nickname`, `user_type`, `status`, `storage_quota`) 
VALUES ('admin', '$2a$10$xyz...', '系统管理员', 1, 1, 107374182400);
```

### 3.2 系统配置

```sql
INSERT INTO `sys_config` (`config_key`, `config_value`, `config_type`, `config_desc`) VALUES
('site.name', '云盘系统', 'string', '网站名称'),
('site.description', '安全、快速、易用的云盘系统', 'string', '网站描述'),
('site.logo', '/logo.png', 'string', '网站Logo'),
('upload.max_size', '104857600', 'number', '单文件最大上传大小（字节）'),
('upload.allow_types', '["jpg","jpeg","png","gif","pdf","txt","doc","docx","xls","xlsx","ppt","pptx","zip","rar","mp4","mp3"]', 'json', '允许上传的文件类型'),
('recycle.expire_days', '30', 'number', '回收站文件保留天数'),
('share.default_expire_days', '7', 'number', '分享默认有效期（天）'),
('security.password_min_length', '6', 'number', '密码最小长度'),
('security.jwt_expire_time', '7200', 'number', 'JWT过期时间（秒）');
```

## 4. 索引优化说明

### 4.1 核心查询场景
1. **用户文件列表查询**: `(user_id, parent_id, deleted)`
2. **文件路径查询**: `(user_id, file_path, deleted)`
3. **文件MD5查询（秒传）**: `(file_md5, user_id)`
4. **分享码查询**: `(share_code)`
5. **操作日志查询**: `(user_id, create_time)`

### 4.2 联合索引建议

```sql
-- 文件表联合索引
ALTER TABLE `file_info` ADD INDEX `idx_user_parent_deleted` (`user_id`, `parent_id`, `deleted`);

-- 操作日志联合索引
ALTER TABLE `file_operation_log` ADD INDEX `idx_user_time` (`user_id`, `create_time`);
```

## 5. 分区方案（可选，大数据量时使用）

### 5.1 操作日志表按月分区

```sql
ALTER TABLE file_operation_log PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    -- 按需添加更多分区
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

## 6. 数据库性能优化建议

1. **定期分析表**: `ANALYZE TABLE file_info;`
2. **定期优化表**: `OPTIMIZE TABLE file_info;`
3. **监控慢查询**: 开启MySQL慢查询日志
4. **合理使用缓存**: 热点数据放入Redis
5. **读写分离**: 主库写，从库读
6. **分库分表**: 用户量大时按user_id进行分片

## 7. 备份策略

1. **全量备份**: 每天凌晨进行全量备份
2. **增量备份**: 每小时进行binlog备份
3. **异地备份**: 定期同步到异地服务器
4. **备份保留**: 保留最近30天的备份

## 8. 数据迁移脚本

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS cloud_disk DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE cloud_disk;

-- 执行上述所有建表语句
-- ...

-- 初始化数据
-- ...
```

