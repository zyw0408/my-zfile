# 云盘系统开发文档 - 后端架构设计

## 1. 后端架构概述

### 1.1 分层架构

```
┌─────────────────────────────────────┐
│         Controller Layer            │  <- API接口层（接收请求、参数校验、返回响应）
├─────────────────────────────────────┤
│         Service Layer               │  <- 业务逻辑层（核心业务处理）
├─────────────────────────────────────┤
│         Repository Layer            │  <- 数据访问层（数据库操作）
├─────────────────────────────────────┤
│         Infrastructure Layer        │  <- 基础设施层（存储、缓存、消息队列）
└─────────────────────────────────────┘
```

### 1.2 模块划分

```
com.cloudisk
├── common                  # 公共模块
│   ├── config             # 配置类
│   ├── constant           # 常量
│   ├── exception          # 异常处理
│   ├── utils              # 工具类
│   ├── aspect             # AOP切面
│   └── interceptor        # 拦截器
├── module
│   ├── auth               # 认证授权模块
│   ├── user               # 用户模块
│   ├── file               # 文件模块
│   ├── storage            # 存储模块
│   ├── share              # 分享模块
│   └── admin              # 管理模块
└── CloudDiskApplication   # 启动类
```

## 2. 核心模块设计

### 2.1 认证授权模块 (auth)

#### 2.1.1 目录结构
```
auth/
├── controller/
│   └── AuthController.java
├── service/
│   ├── AuthService.java
│   └── impl/
│       └── AuthServiceImpl.java
├── dto/
│   ├── LoginRequest.java
│   ├── RegisterRequest.java
│   └── TokenResponse.java
└── security/
    ├── JwtTokenProvider.java
    ├── JwtAuthenticationFilter.java
    └── UserDetailsServiceImpl.java
```

#### 2.1.2 核心类设计

**JwtTokenProvider.java** - JWT工具类
```java
@Component
public class JwtTokenProvider {
    
    @Value("${jwt.secret}")
    private String jwtSecret;
    
    @Value("${jwt.expiration}")
    private long jwtExpiration;
    
    // 生成Token
    public String generateToken(Long userId, String username);
    
    // 验证Token
    public boolean validateToken(String token);
    
    // 从Token获取用户ID
    public Long getUserIdFromToken(String token);
    
    // 刷新Token
    public String refreshToken(String token);
}
```

**AuthService.java** - 认证服务接口
```java
public interface AuthService {
    
    // 用户登录
    TokenResponse login(LoginRequest request);
    
    // 用户注册
    void register(RegisterRequest request);
    
    // 退出登录
    void logout(String token);
    
    // 刷新Token
    TokenResponse refreshToken(String refreshToken);
    
    // 发送验证码
    void sendVerificationCode(String email);
}
```

### 2.2 文件模块 (file)

#### 2.2.1 目录结构
```
file/
├── controller/
│   ├── FileController.java
│   └── FolderController.java
├── service/
│   ├── FileService.java
│   ├── FileUploadService.java
│   ├── FileDownloadService.java
│   ├── FilePreviewService.java
│   └── impl/
│       ├── FileServiceImpl.java
│       ├── FileUploadServiceImpl.java
│       ├── FileDownloadServiceImpl.java
│       └── FilePreviewServiceImpl.java
├── mapper/
│   └── FileInfoMapper.java
├── entity/
│   └── FileInfo.java
├── dto/
│   ├── FileUploadRequest.java
│   ├── FileListRequest.java
│   ├── FileResponse.java
│   └── FileDetailResponse.java
└── enums/
    ├── FileTypeEnum.java
    └── FileStatusEnum.java
```

#### 2.2.2 核心服务设计

**FileService.java** - 文件服务接口
```java
public interface FileService {
    
    // 获取文件列表
    PageResult<FileResponse> listFiles(FileListRequest request);
    
    // 获取文件详情
    FileDetailResponse getFileDetail(Long fileId);
    
    // 创建文件夹
    Long createFolder(String folderName, Long parentId);
    
    // 重命名文件
    void renameFile(Long fileId, String newName);
    
    // 移动文件
    void moveFile(Long fileId, Long targetFolderId);
    
    // 复制文件
    void copyFile(Long fileId, Long targetFolderId);
    
    // 删除文件（移入回收站）
    void deleteFile(Long fileId);
    
    // 批量删除
    void batchDelete(List<Long> fileIds);
    
    // 搜索文件
    PageResult<FileResponse> searchFiles(String keyword, Integer pageNum, Integer pageSize);
    
    // 获取文件夹大小
    Long getFolderSize(Long folderId);
}
```

**FileUploadService.java** - 文件上传服务
```java
public interface FileUploadService {
    
    // 单文件上传
    FileResponse uploadFile(MultipartFile file, Long parentId);
    
    // 分片上传初始化
    ChunkUploadInitResponse initChunkUpload(ChunkUploadInitRequest request);
    
    // 上传分片
    void uploadChunk(ChunkUploadRequest request);
    
    // 合并分片
    FileResponse mergeChunks(ChunkMergeRequest request);
    
    // 秒传检查
    SecUploadResponse checkSecUpload(String fileMd5, Long fileSize);
    
    // 取消上传
    void cancelUpload(String uploadId);
}
```

**FileDownloadService.java** - 文件下载服务
```java
public interface FileDownloadService {
    
    // 下载单个文件
    void downloadFile(Long fileId, HttpServletResponse response);
    
    // 批量下载（打包为ZIP）
    void batchDownload(List<Long> fileIds, HttpServletResponse response);
    
    // 生成下载链接
    String generateDownloadUrl(Long fileId, Integer expireSeconds);
    
    // 获取文件流（用于预览）
    InputStream getFileStream(Long fileId);
}
```

**FilePreviewService.java** - 文件预览服务
```java
public interface FilePreviewService {
    
    // 获取文件预览URL
    String getPreviewUrl(Long fileId);
    
    // 获取图片缩略图
    String getThumbnailUrl(Long fileId);
    
    // 获取视频封面
    String getVideoCover(Long fileId);
    
    // 获取文本内容
    String getTextContent(Long fileId);
    
    // 检查文件是否支持预览
    boolean isSupportPreview(String fileType);
}
```

### 2.3 存储模块 (storage)

#### 2.3.1 目录结构
```
storage/
├── service/
│   ├── StorageService.java          # 存储服务接口
│   └── impl/
│       ├── LocalStorageService.java     # 本地存储实现
│       ├── AliyunOssStorageService.java # 阿里云OSS实现
│       └── TencentCosStorageService.java # 腾讯云COS实现
├── factory/
│   └── StorageServiceFactory.java   # 存储服务工厂
├── config/
│   ├── StorageConfig.java
│   └── StorageProperties.java
└── dto/
    ├── UploadResult.java
    └── StorageInfo.java
```

#### 2.3.2 存储服务接口设计

**StorageService.java** - 统一存储接口
```java
public interface StorageService {
    
    // 上传文件
    UploadResult upload(InputStream inputStream, String fileName, String contentType);
    
    // 下载文件
    InputStream download(String filePath);
    
    // 删除文件
    void delete(String filePath);
    
    // 复制文件
    void copy(String sourcePath, String targetPath);
    
    // 检查文件是否存在
    boolean exists(String filePath);
    
    // 获取文件访问URL
    String getFileUrl(String filePath);
    
    // 获取临时访问URL（带签名）
    String getPresignedUrl(String filePath, Integer expireSeconds);
    
    // 获取存储类型
    StorageTypeEnum getStorageType();
}
```

**StorageServiceFactory.java** - 存储服务工厂
```java
@Component
public class StorageServiceFactory {
    
    @Autowired
    private LocalStorageService localStorageService;
    
    @Autowired(required = false)
    private AliyunOssStorageService aliyunOssStorageService;
    
    @Autowired(required = false)
    private TencentCosStorageService tencentCosStorageService;
    
    // 根据存储类型获取对应服务
    public StorageService getStorageService(StorageTypeEnum storageType) {
        switch (storageType) {
            case LOCAL:
                return localStorageService;
            case ALIYUN_OSS:
                return aliyunOssStorageService;
            case TENCENT_COS:
                return tencentCosStorageService;
            default:
                throw new BusinessException("不支持的存储类型");
        }
    }
    
    // 获取默认存储服务
    public StorageService getDefaultStorageService() {
        // 从配置中读取默认存储类型
        return getStorageService(StorageTypeEnum.LOCAL);
    }
}
```

### 2.4 分享模块 (share)

#### 2.4.1 目录结构
```
share/
├── controller/
│   └── ShareController.java
├── service/
│   ├── ShareService.java
│   └── impl/
│       └── ShareServiceImpl.java
├── mapper/
│   └── FileShareMapper.java
├── entity/
│   └── FileShare.java
└── dto/
    ├── CreateShareRequest.java
    ├── ShareResponse.java
    └── ShareAccessRequest.java
```

#### 2.4.2 核心服务设计

**ShareService.java** - 分享服务接口
```java
public interface ShareService {
    
    // 创建分享
    ShareResponse createShare(CreateShareRequest request);
    
    // 获取分享信息（需要验证密码）
    ShareDetailResponse getShareDetail(String shareCode, String password);
    
    // 访问分享文件
    FileResponse accessShareFile(String shareCode);
    
    // 取消分享
    void cancelShare(Long shareId);
    
    // 获取我的分享列表
    PageResult<ShareResponse> listMyShares(Integer pageNum, Integer pageSize);
    
    // 检查分享是否有效
    boolean checkShareValid(String shareCode);
    
    // 生成分享二维码
    String generateQrCode(String shareCode);
}
```

### 2.5 用户模块 (user)

#### 2.5.1 目录结构
```
user/
├── controller/
│   └── UserController.java
├── service/
│   ├── UserService.java
│   └── impl/
│       └── UserServiceImpl.java
├── mapper/
│   └── UserMapper.java
├── entity/
│   └── User.java
└── dto/
    ├── UserProfileResponse.java
    ├── UpdateProfileRequest.java
    └── ChangePasswordRequest.java
```

### 2.6 管理模块 (admin)

#### 2.6.1 目录结构
```
admin/
├── controller/
│   ├── AdminUserController.java
│   ├── AdminFileController.java
│   ├── AdminStorageController.java
│   └── AdminSystemController.java
├── service/
│   ├── AdminUserService.java
│   ├── AdminFileService.java
│   ├── AdminStorageService.java
│   └── AdminSystemService.java
└── dto/
    ├── UserManageRequest.java
    ├── FileStatisticsResponse.java
    ├── SystemInfoResponse.java
    └── StorageConfigRequest.java
```

## 3. 公共模块设计

### 3.1 配置类 (config)

#### SecurityConfig.java - 安全配置
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf().disable()
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/api/share/**").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtAuthenticationFilter(), 
                UsernamePasswordAuthenticationFilter.class);
        return http.build();
    }
}
```

#### WebMvcConfig.java - MVC配置
```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("*")
                .allowedMethods("*")
                .allowedHeaders("*");
    }
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LogInterceptor())
                .addPathPatterns("/**");
    }
}
```

#### MyBatisPlusConfig.java - MyBatis配置
```java
@Configuration
public class MyBatisPlusConfig {
    
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        // 分页插件
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor());
        return interceptor;
    }
}
```

#### RedisConfig.java - Redis配置
```java
@Configuration
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(
            RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // 使用Jackson序列化
        Jackson2JsonRedisSerializer<Object> serializer = 
            new Jackson2JsonRedisSerializer<>(Object.class);
        
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        
        return template;
    }
}
```

### 3.2 异常处理 (exception)

#### GlobalExceptionHandler.java - 全局异常处理
```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<?> handleBusinessException(BusinessException e) {
        log.error("业务异常：{}", e.getMessage());
        return Result.fail(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<?> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getAllErrors()
                .stream()
                .map(DefaultMessageSourceResolvable::getDefaultMessage)
                .collect(Collectors.joining(", "));
        return Result.fail(400, message);
    }
    
    @ExceptionHandler(Exception.class)
    public Result<?> handleException(Exception e) {
        log.error("系统异常：", e);
        return Result.fail(500, "系统内部错误");
    }
}
```

#### BusinessException.java - 业务异常
```java
@Data
@EqualsAndHashCode(callSuper = true)
public class BusinessException extends RuntimeException {
    
    private Integer code;
    
    public BusinessException(String message) {
        super(message);
        this.code = 400;
    }
    
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
    }
    
    public BusinessException(ErrorCodeEnum errorCode) {
        super(errorCode.getMessage());
        this.code = errorCode.getCode();
    }
}
```

### 3.3 工具类 (utils)

#### FileUtil.java - 文件工具类
```java
public class FileUtil {
    
    // 获取文件扩展名
    public static String getFileExtension(String fileName);
    
    // 获取文件MIME类型
    public static String getContentType(String fileName);
    
    // 生成唯一文件名
    public static String generateUniqueFileName(String originalFileName);
    
    // 计算文件MD5
    public static String calculateMd5(InputStream inputStream);
    
    // 格式化文件大小
    public static String formatFileSize(Long size);
    
    // 判断是否为图片
    public static boolean isImage(String fileType);
    
    // 判断是否为视频
    public static boolean isVideo(String fileType);
    
    // 判断是否为音频
    public static boolean isAudio(String fileType);
}
```

#### RedisUtil.java - Redis工具类
```java
@Component
public class RedisUtil {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // 设置缓存
    public void set(String key, Object value, long timeout, TimeUnit unit);
    
    // 获取缓存
    public Object get(String key);
    
    // 删除缓存
    public void delete(String key);
    
    // 批量删除
    public void delete(Collection<String> keys);
    
    // 判断key是否存在
    public boolean hasKey(String key);
    
    // 设置过期时间
    public void expire(String key, long timeout, TimeUnit unit);
}
```

### 3.4 切面 (aspect)

#### LogAspect.java - 日志切面
```java
@Aspect
@Component
@Slf4j
public class LogAspect {
    
    @Pointcut("execution(* com.cloudisk.module.*.controller.*.*(..))")
    public void controllerPointcut() {}
    
    @Around("controllerPointcut()")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        // 获取请求信息
        HttpServletRequest request = 
            ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes())
                .getRequest();
        
        String method = request.getMethod();
        String url = request.getRequestURI();
        String ip = getIpAddress(request);
        
        log.info("请求开始 => Method: {}, URL: {}, IP: {}", method, url, ip);
        
        // 执行方法
        Object result = point.proceed();
        
        long endTime = System.currentTimeMillis();
        log.info("请求结束 => 耗时: {}ms", endTime - startTime);
        
        return result;
    }
}
```

## 4. 统一响应格式

### Result.java - 统一响应类
```java
@Data
public class Result<T> {
    
    private Integer code;
    private String message;
    private T data;
    private Long timestamp;
    
    public static <T> Result<T> success() {
        return success(null);
    }
    
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
    
    public static <T> Result<T> fail(String message) {
        return fail(400, message);
    }
    
    public static <T> Result<T> fail(Integer code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
}
```

### PageResult.java - 分页响应类
```java
@Data
public class PageResult<T> {
    
    private Long total;
    private Integer pageNum;
    private Integer pageSize;
    private Integer totalPages;
    private List<T> records;
    
    public static <T> PageResult<T> of(Page<T> page) {
        PageResult<T> result = new PageResult<>();
        result.setTotal(page.getTotal());
        result.setPageNum((int) page.getCurrent());
        result.setPageSize((int) page.getSize());
        result.setTotalPages((int) page.getPages());
        result.setRecords(page.getRecords());
        return result;
    }
}
```

## 5. 配置文件

### application.yml
```yaml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  application:
    name: cloud-disk
  
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/cloud_disk?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: root
  
  redis:
    host: localhost
    port: 6379
    password:
    database: 0
  
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 500MB

mybatis-plus:
  mapper-locations: classpath:mapper/**/*.xml
  type-aliases-package: com.cloudisk.module.*.entity
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
    map-underscore-to-camel-case: true

jwt:
  secret: your-jwt-secret-key-must-be-long-enough
  expiration: 7200000  # 2小时

storage:
  type: local  # local, aliyun_oss, tencent_cos
  local:
    base-path: /data/upload
    url-prefix: http://localhost:8080/files
  aliyun-oss:
    endpoint: oss-cn-hangzhou.aliyuncs.com
    access-key-id: your-access-key
    access-key-secret: your-secret-key
    bucket-name: your-bucket
  tencent-cos:
    region: ap-guangzhou
    secret-id: your-secret-id
    secret-key: your-secret-key
    bucket-name: your-bucket
```

## 6. Maven依赖 (pom.xml 核心部分)

```xml
<dependencies>
    <!-- Spring Boot -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <!-- MySQL -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
    </dependency>
    
    <!-- MyBatis Plus -->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
        <version>3.5.5</version>
    </dependency>
    
    <!-- Redis -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    
    <!-- JWT -->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-api</artifactId>
        <version>0.11.5</version>
    </dependency>
    
    <!-- Knife4j (Swagger) -->
    <dependency>
        <groupId>com.github.xiaoymin</groupId>
        <artifactId>knife4j-openapi3-jakarta-spring-boot-starter</artifactId>
        <version>4.3.0</version>
    </dependency>
    
    <!-- 阿里云OSS -->
    <dependency>
        <groupId>com.aliyun.oss</groupId>
        <artifactId>aliyun-sdk-oss</artifactId>
        <version>3.17.1</version>
    </dependency>
    
    <!-- 腾讯云COS -->
    <dependency>
        <groupId>com.qcloud</groupId>
        <artifactId>cos_api</artifactId>
        <version>5.6.155</version>
    </dependency>
    
    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
</dependencies>
```

