# 云盘系统开发文档 - 开发指南与最佳实践

## 1. 开发环境搭建

### 1.1 IDE配置

#### 1.1.1 IntelliJ IDEA (后端)

**推荐插件**:
- Lombok Plugin
- MyBatis X
- Spring Boot Helper
- Maven Helper
- Alibaba Java Coding Guidelines
- SonarLint

**代码样式配置**:
```xml
<!-- settings.xml -->
<code_scheme name="Cloud Disk">
  <option name="INDENT_SIZE" value="4"/>
  <option name="TAB_SIZE" value="4"/>
  <option name="USE_TAB_CHARACTER" value="false"/>
  <JavaCodeStyleSettings>
    <option name="CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND" value="999"/>
    <option name="NAMES_COUNT_TO_USE_IMPORT_ON_DEMAND" value="999"/>
  </JavaCodeStyleSettings>
</code_scheme>
```

#### 1.1.2 VS Code (前端)

**推荐插件**:
- Vue Language Features (Volar)
- TypeScript Vue Plugin (Volar)
- ESLint
- Prettier
- Auto Rename Tag
- Path Intellisense
- GitLens

**settings.json**:
```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.preferences.importModuleSpecifier": "relative",
  "typescript.updateImportsOnFileMove.enabled": "always"
}
```

### 1.2 本地开发环境

#### 1.2.1 快速启动脚本

**后端启动 (start-backend.sh)**:
```bash
#!/bin/bash

# 启动MySQL
docker run -d --name cloud-disk-mysql \
  -e MYSQL_ROOT_PASSWORD=root \
  -e MYSQL_DATABASE=cloud_disk \
  -p 3306:3306 \
  mysql:8.0

# 启动Redis
docker run -d --name cloud-disk-redis \
  -p 6379:6379 \
  redis:7.0-alpine

# 等待数据库启动
sleep 10

# 导入数据库
mysql -h 127.0.0.1 -u root -proot cloud_disk < init.sql

# 启动后端应用
./mvnw spring-boot:run
```

**前端启动 (start-frontend.sh)**:
```bash
#!/bin/bash

# 安装依赖（首次运行）
if [ ! -d "node_modules" ]; then
  pnpm install
fi

# 启动开发服务器
pnpm dev
```

## 2. 代码规范

### 2.1 Java代码规范

#### 2.1.1 命名规范

```java
// 类名：大驼峰（PascalCase）
public class FileUploadService { }

// 接口名：大驼峰，I开头（可选）
public interface IFileService { }

// 方法名：小驼峰（camelCase）
public void uploadFile() { }

// 变量名：小驼峰
private String fileName;

// 常量：全大写，下划线分隔
private static final int MAX_FILE_SIZE = 1024;

// 包名：全小写
package com.cloudisk.module.file;
```

#### 2.1.2 注释规范

```java
/**
 * 文件上传服务
 * 
 * @author YourName
 * @since 2025-01-01
 */
@Service
@Slf4j
public class FileUploadService {
    
    /**
     * 上传单个文件
     * 
     * @param file 文件对象
     * @param parentId 父文件夹ID
     * @return 文件信息
     * @throws BusinessException 业务异常
     */
    public FileInfo uploadFile(MultipartFile file, Long parentId) {
        // 1. 参数验证
        validateFile(file);
        
        // 2. 计算MD5
        String md5 = calculateMd5(file);
        
        // 3. 秒传检查
        if (checkSecUpload(md5)) {
            return handleSecUpload(md5, parentId);
        }
        
        // 4. 上传文件
        String storePath = saveFile(file);
        
        // 5. 保存记录
        return saveFileRecord(file, storePath, parentId);
    }
}
```

#### 2.1.3 异常处理

```java
// 好的实践
public FileInfo getFile(Long fileId) {
    FileInfo file = fileMapper.selectById(fileId);
    
    if (file == null) {
        throw new BusinessException(ErrorCode.FILE_NOT_FOUND);
    }
    
    if (!checkPermission(file)) {
        throw new BusinessException(ErrorCode.NO_PERMISSION);
    }
    
    return file;
}

// 避免的写法
public FileInfo getFile(Long fileId) {
    try {
        return fileMapper.selectById(fileId);
    } catch (Exception e) {
        e.printStackTrace(); // 不要只打印异常
        return null; // 不要吞掉异常
    }
}
```

### 2.2 TypeScript/Vue代码规范

#### 2.2.1 命名规范

```typescript
// 组件名：大驼峰
export default defineComponent({
  name: 'FileList'
})

// 函数名：小驼峰
const uploadFile = () => { }

// 变量名：小驼峰
const fileList = ref<FileInfo[]>([])

// 常量：全大写
const MAX_FILE_SIZE = 100 * 1024 * 1024

// 接口/类型：大驼峰
interface FileInfo {
  id: number
  fileName: string
}

// 枚举：大驼峰
enum FileType {
  Document = 'document',
  Image = 'image'
}
```

#### 2.2.2 Vue组件结构

```vue
<template>
  <div class="file-list">
    <!-- 组件内容 -->
  </div>
</template>

<script setup lang="ts">
// 1. 导入
import { ref, computed, onMounted } from 'vue'
import { useFileStore } from '@/stores/file'

// 2. Props定义
interface Props {
  parentId?: number
}
const props = withDefaults(defineProps<Props>(), {
  parentId: 0
})

// 3. Emits定义
interface Emits {
  (e: 'select', file: FileInfo): void
  (e: 'delete', id: number): void
}
const emit = defineEmits<Emits>()

// 4. 状态
const fileStore = useFileStore()
const loading = ref(false)
const fileList = ref<FileInfo[]>([])

// 5. 计算属性
const totalSize = computed(() => 
  fileList.value.reduce((sum, file) => sum + file.fileSize, 0)
)

// 6. 方法
const loadFiles = async () => {
  loading.value = true
  try {
    const data = await fileApi.getFileList(props.parentId)
    fileList.value = data.records
  } finally {
    loading.value = false
  }
}

// 7. 生命周期
onMounted(() => {
  loadFiles()
})
</script>

<style scoped lang="scss">
.file-list {
  // 样式
}
</style>
```

## 3. Git工作流

### 3.1 分支管理

```
main (生产环境)
  │
  ├── develop (开发环境)
  │     │
  │     ├── feature/file-upload (功能分支)
  │     ├── feature/user-auth
  │     └── feature/file-share
  │
  ├── hotfix/fix-upload-bug (热修复)
  └── release/v1.0.0 (发布分支)
```

### 3.2 提交规范

#### 3.2.1 Commit Message格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type类型**:
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式（不影响代码运行）
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建/工具链相关
- `revert`: 回滚

**示例**:
```bash
# 好的提交
git commit -m "feat(file): add file upload with chunk support"
git commit -m "fix(auth): resolve token refresh issue"
git commit -m "docs(api): update file API documentation"

# 不好的提交
git commit -m "update"
git commit -m "fix bug"
git commit -m "修改文件"
```

#### 3.2.2 使用Commitlint

```javascript
// commitlint.config.js
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'feat', 'fix', 'docs', 'style', 'refactor',
        'perf', 'test', 'chore', 'revert'
      ]
    ],
    'subject-max-length': [2, 'always', 100],
    'subject-case': [0]
  }
}
```

### 3.3 开发流程

```bash
# 1. 创建功能分支
git checkout -b feature/file-upload develop

# 2. 开发功能
# ... 编写代码 ...

# 3. 提交代码
git add .
git commit -m "feat(file): implement file upload"

# 4. 推送到远程
git push origin feature/file-upload

# 5. 创建Pull Request
# 在GitHub/GitLab上创建PR

# 6. 代码审查
# 团队成员进行代码审查

# 7. 合并到develop
git checkout develop
git merge --no-ff feature/file-upload

# 8. 删除功能分支
git branch -d feature/file-upload
git push origin --delete feature/file-upload
```

## 4. 测试最佳实践

### 4.1 单元测试

#### 4.1.1 JUnit 5示例

```java
@SpringBootTest
@Transactional
class FileServiceTest {
    
    @Autowired
    private FileService fileService;
    
    @MockBean
    private FileMapper fileMapper;
    
    @Test
    @DisplayName("测试文件上传-成功")
    void testUploadFile_Success() {
        // Given
        MockMultipartFile file = new MockMultipartFile(
            "file",
            "test.txt",
            "text/plain",
            "Hello World".getBytes()
        );
        
        // When
        FileInfo result = fileService.uploadFile(file, 0L);
        
        // Then
        assertNotNull(result);
        assertEquals("test.txt", result.getFileName());
    }
    
    @Test
    @DisplayName("测试文件上传-文件为空")
    void testUploadFile_EmptyFile() {
        // Given
        MockMultipartFile file = new MockMultipartFile(
            "file",
            "test.txt",
            "text/plain",
            new byte[0]
        );
        
        // When & Then
        assertThrows(BusinessException.class, () -> {
            fileService.uploadFile(file, 0L);
        });
    }
    
    @Test
    @DisplayName("测试文件删除")
    void testDeleteFile() {
        // Given
        Long fileId = 1L;
        FileInfo file = new FileInfo();
        file.setId(fileId);
        file.setUserId(1L);
        
        when(fileMapper.selectById(fileId)).thenReturn(file);
        
        // When
        fileService.deleteFile(fileId);
        
        // Then
        verify(fileMapper, times(1)).deleteById(fileId);
    }
}
```

#### 4.1.2 Vue测试示例

```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { mount } from '@vue/test-utils'
import FileList from '@/components/FileList/index.vue'

describe('FileList.vue', () => {
  let wrapper: any
  
  beforeEach(() => {
    wrapper = mount(FileList, {
      props: {
        files: [
          { id: 1, fileName: 'test1.txt', fileSize: 1024 },
          { id: 2, fileName: 'test2.pdf', fileSize: 2048 }
        ]
      }
    })
  })
  
  it('renders files correctly', () => {
    expect(wrapper.findAll('.file-item')).toHaveLength(2)
  })
  
  it('emits select event when file clicked', async () => {
    await wrapper.find('.file-item').trigger('click')
    expect(wrapper.emitted('select')).toBeTruthy()
  })
  
  it('displays file size correctly', () => {
    const firstFile = wrapper.find('.file-item')
    expect(firstFile.text()).toContain('1.00 KB')
  })
})
```

### 4.2 集成测试

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
class FileControllerIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Test
    @WithMockUser(username = "testuser")
    void testGetFileList() throws Exception {
        mockMvc.perform(get("/api/files")
                .param("parentId", "0")
                .param("pageNum", "1")
                .param("pageSize", "20"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(200))
            .andExpect(jsonPath("$.data.records").isArray())
            .andDo(print());
    }
    
    @Test
    @WithMockUser(username = "testuser")
    void testUploadFile() throws Exception {
        MockMultipartFile file = new MockMultipartFile(
            "file",
            "test.txt",
            "text/plain",
            "Hello World".getBytes()
        );
        
        mockMvc.perform(multipart("/api/files/upload")
                .file(file)
                .param("parentId", "0"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.code").value(200))
            .andDo(print());
    }
}
```

### 4.3 性能测试

#### 4.3.1 JMeter测试计划

```xml
<!-- 文件上传性能测试 -->
<TestPlan>
  <ThreadGroup>
    <stringProp name="ThreadGroup.num_threads">100</stringProp>
    <stringProp name="ThreadGroup.ramp_time">10</stringProp>
    <stringProp name="ThreadGroup.duration">60</stringProp>
  </ThreadGroup>
  
  <HTTPSamplerProxy>
    <stringProp name="HTTPSampler.domain">localhost</stringProp>
    <stringProp name="HTTPSampler.port">8080</stringProp>
    <stringProp name="HTTPSampler.path">/api/files/upload</stringProp>
    <stringProp name="HTTPSampler.method">POST</stringProp>
  </HTTPSamplerProxy>
</TestPlan>
```

## 5. 代码质量

### 5.1 代码审查清单

#### 5.1.1 功能性
- [ ] 功能是否符合需求
- [ ] 边界条件是否处理
- [ ] 错误处理是否完善
- [ ] 是否有单元测试

#### 5.1.2 性能
- [ ] 是否存在N+1查询
- [ ] 是否有不必要的循环
- [ ] 大数据量是否分页
- [ ] 是否使用缓存

#### 5.1.3 安全性
- [ ] 是否验证用户权限
- [ ] 是否防止SQL注入
- [ ] 是否防止XSS攻击
- [ ] 敏感数据是否加密

#### 5.1.4 可维护性
- [ ] 代码是否清晰易懂
- [ ] 是否有适当的注释
- [ ] 命名是否规范
- [ ] 是否遵循设计模式

### 5.2 静态代码分析

#### 5.2.1 SonarQube配置

```properties
# sonar-project.properties
sonar.projectKey=cloud-disk
sonar.projectName=Cloud Disk System
sonar.projectVersion=1.0.0

sonar.sources=src/main/java
sonar.tests=src/test/java
sonar.java.binaries=target/classes

sonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

sonar.exclusions=**/config/**,**/entity/**
```

#### 5.2.2 运行分析

```bash
# Maven项目
mvn clean verify sonar:sonar \
  -Dsonar.projectKey=cloud-disk \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.login=your_token
```

## 6. 性能优化技巧

### 6.1 后端优化

#### 6.1.1 数据库优化

```java
// 批量插入
@Service
public class FileService {
    
    // 不好的做法
    public void saveFiles(List<FileInfo> files) {
        for (FileInfo file : files) {
            fileMapper.insert(file);  // N次数据库操作
        }
    }
    
    // 好的做法
    public void saveFiles(List<FileInfo> files) {
        fileMapper.batchInsert(files);  // 1次数据库操作
    }
}
```

```xml
<!-- MyBatis批量插入 -->
<insert id="batchInsert" parameterType="list">
    INSERT INTO file_info (file_name, file_size, user_id)
    VALUES
    <foreach collection="list" item="item" separator=",">
        (#{item.fileName}, #{item.fileSize}, #{item.userId})
    </foreach>
</insert>
```

#### 6.1.2 缓存使用

```java
@Service
public class FileService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // 使用缓存
    @Cacheable(value = "file", key = "#fileId")
    public FileInfo getFile(Long fileId) {
        return fileMapper.selectById(fileId);
    }
    
    // 更新缓存
    @CachePut(value = "file", key = "#file.id")
    public FileInfo updateFile(FileInfo file) {
        fileMapper.updateById(file);
        return file;
    }
    
    // 删除缓存
    @CacheEvict(value = "file", key = "#fileId")
    public void deleteFile(Long fileId) {
        fileMapper.deleteById(fileId);
    }
}
```

#### 6.1.3 异步处理

```java
@Service
public class FileService {
    
    @Async
    public CompletableFuture<String> generateThumbnail(Long fileId) {
        // 异步生成缩略图
        String thumbnailUrl = thumbnailGenerator.generate(fileId);
        return CompletableFuture.completedFuture(thumbnailUrl);
    }
    
    @Async
    public void sendNotification(Long userId, String message) {
        // 异步发送通知
        notificationService.send(userId, message);
    }
}
```

### 6.2 前端优化

#### 6.2.1 懒加载

```typescript
// 路由懒加载
const routes = [
  {
    path: '/file-manage',
    component: () => import('@/views/user/FileManage.vue')
  }
]

// 组件懒加载
const FileUpload = defineAsyncComponent(() =>
  import('@/components/FileUpload/index.vue')
)
```

#### 6.2.2 虚拟滚动

```vue
<template>
  <el-virtual-list
    :data="fileList"
    :item-size="60"
    :height="600"
  >
    <template #default="{ item }">
      <FileItem :file="item" />
    </template>
  </el-virtual-list>
</template>
```

#### 6.2.3 防抖节流

```typescript
import { debounce, throttle } from 'lodash-es'

// 防抖：搜索输入
const handleSearch = debounce((keyword: string) => {
  searchFiles(keyword)
}, 500)

// 节流：滚动加载
const handleScroll = throttle(() => {
  loadMoreFiles()
}, 200)
```

## 7. 调试技巧

### 7.1 后端调试

#### 7.1.1 远程调试

```bash
# 启动应用时添加调试参数
java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005 -jar app.jar
```

在IDEA中配置远程调试：
```
Run -> Edit Configurations -> Add New Configuration -> Remote JVM Debug
Host: localhost
Port: 5005
```

#### 7.1.2 日志调试

```java
@Slf4j
public class FileService {
    
    public void uploadFile(MultipartFile file) {
        log.debug("开始上传文件: {}", file.getOriginalFilename());
        log.debug("文件大小: {} bytes", file.getSize());
        
        try {
            // 上传逻辑
            log.info("文件上传成功: {}", file.getOriginalFilename());
        } catch (Exception e) {
            log.error("文件上传失败", e);
            throw new BusinessException("上传失败");
        }
    }
}
```

### 7.2 前端调试

#### 7.2.1 Vue Devtools

```typescript
// 开发环境下启用
if (import.meta.env.DEV) {
  app.config.performance = true
}
```

#### 7.2.2 调试技巧

```typescript
// 使用debugger
const uploadFile = async (file: File) => {
  debugger  // 断点
  const result = await fileApi.uploadFile(file)
  console.log('上传结果：', result)
}

// 使用console.table
console.table(fileList.value)

// 使用console.time
console.time('upload')
await uploadFile(file)
console.timeEnd('upload')
```

## 8. 常见问题解决

### 8.1 后端问题

#### 8.1.1 跨域问题

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

#### 8.1.2 文件上传大小限制

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 500MB
```

### 8.2 前端问题

#### 8.2.1 文件上传进度

```typescript
const uploadFile = (file: File) => {
  const formData = new FormData()
  formData.append('file', file)
  
  return axios.post('/api/files/upload', formData, {
    onUploadProgress: (progressEvent) => {
      const percent = Math.round(
        (progressEvent.loaded * 100) / progressEvent.total!
      )
      console.log(`上传进度: ${percent}%`)
    }
  })
}
```

#### 8.2.2 大文件分片上传

```typescript
const chunkSize = 5 * 1024 * 1024  // 5MB
const chunks = Math.ceil(file.size / chunkSize)

for (let i = 0; i < chunks; i++) {
  const start = i * chunkSize
  const end = Math.min(start + chunkSize, file.size)
  const chunk = file.slice(start, end)
  
  await uploadChunk(chunk, i)
}
```

## 9. 文档维护

### 9.1 代码文档

```java
/**
 * 生成JavaDoc
 */
// Maven命令
mvn javadoc:javadoc

// Gradle命令
./gradlew javadoc
```

### 9.2 API文档

使用Knife4j自动生成API文档：

```java
@Configuration
@EnableKnife4j
public class Knife4jConfig {
    
    @Bean
    public Docket createRestApi() {
        return new Docket(DocumentationType.OAS_30)
                .apiInfo(apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.cloudisk"))
                .paths(PathSelectors.any())
                .build();
    }
    
    private ApiInfo apiInfo() {
        return new ApiInfoBuilder()
                .title("云盘系统API文档")
                .description("云盘系统后端接口文档")
                .version("1.0.0")
                .build();
    }
}
```

访问: `http://localhost:8080/doc.html`

## 10. 持续集成

### 10.1 GitHub Actions

``yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Run tests
      run: mvn test
  
  frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install pnpm
      run: npm install -g pnpm
    
    - name: Install dependencies
      run: pnpm install
    
    - name: Build
      run: pnpm build
    
    - name: Run tests
      run: pnpm test
```

这套完整的开发文档涵盖了云盘系统从项目概述、数据库设计、后端架构、API接口、前端架构、安全设计、部署运维到开发指南的所有方面，为项目开发提供了全面的指导和参考。

