# 云盘系统开发文档 - 部署运维

## 1. 环境要求

### 1.1 服务器配置

#### 开发环境
- CPU: 2核
- 内存: 4GB
- 磁盘: 50GB
- 系统: Ubuntu 20.04 / CentOS 7+

#### 生产环境（推荐）
- CPU: 4核+
- 内存: 8GB+
- 磁盘: 200GB+ SSD
- 系统: Ubuntu 20.04 LTS / CentOS 8
- 带宽: 10Mbps+

### 1.2 软件依赖

| 软件 | 版本要求 | 用途 |
|------|---------|------|
| Java | 17+ | 后端运行环境 |
| Node.js | 18+ | 前端构建 |
| MySQL | 8.0+ | 数据库 |
| Redis | 7.0+ | 缓存 |
| Nginx | 1.20+ | 反向代理 |
| Docker | 20.10+ | 容器化部署（可选） |

## 2. Docker部署（推荐）

### 2.1 目录结构

```
cloud-disk-deploy/
├── docker-compose.yml
├── .env
├── nginx/
│   ├── nginx.conf
│   └── ssl/
│       ├── cert.pem
│       └── key.pem
├── mysql/
│   ├── init.sql
│   └── my.cnf
├── backend/
│   └── Dockerfile
└── frontend/
    └── Dockerfile
```

### 2.2 Docker Compose配置

#### docker-compose.yml
```yaml
version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: cloud-disk-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      TZ: Asia/Shanghai
    volumes:
      - ./mysql/data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    ports:
      - "3306:3306"
    networks:
      - cloud-disk-network
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci

  # Redis缓存
  redis:
    image: redis:7.0-alpine
    container_name: cloud-disk-redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - ./redis/data:/data
    ports:
      - "6379:6379"
    networks:
      - cloud-disk-network

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cloud-disk-backend
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: prod
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USERNAME: root
      MYSQL_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - ./backend/upload:/data/upload
      - ./backend/logs:/app/logs
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
    networks:
      - cloud-disk-network

  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: cloud-disk-frontend
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - backend
    networks:
      - cloud-disk-network

networks:
  cloud-disk-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
```

#### .env配置文件
```env
# MySQL配置
MYSQL_ROOT_PASSWORD=your_strong_password
MYSQL_DATABASE=cloud_disk

# Redis配置
REDIS_PASSWORD=your_redis_password

# JWT配置
JWT_SECRET=your_jwt_secret_key_at_least_256_bits_long

# 其他配置
TZ=Asia/Shanghai
```

### 2.3 后端Dockerfile

```dockerfile
# 构建阶段
FROM maven:3.8-openjdk-17 AS builder

WORKDIR /app

# 复制pom.xml并下载依赖
COPY pom.xml .
RUN mvn dependency:go-offline

# 复制源码并构建
COPY src ./src
RUN mvn clean package -DskipTests

# 运行阶段
FROM openjdk:17-slim

WORKDIR /app

# 安装必要工具
RUN apt-get update && \
    apt-get install -y curl && \
    rm -rf /var/lib/apt/lists/*

# 从构建阶段复制jar包
COPY --from=builder /app/target/*.jar app.jar

# 创建日志目录
RUN mkdir -p /app/logs

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
    CMD curl -f http://localhost:8080/api/health || exit 1

# 启动应用
ENTRYPOINT ["java", \
    "-Xms512m", \
    "-Xmx2g", \
    "-XX:+UseG1GC", \
    "-XX:MaxGCPauseMillis=200", \
    "-Dfile.encoding=UTF-8", \
    "-Duser.timezone=Asia/Shanghai", \
    "-jar", \
    "app.jar"]
```

### 2.4 前端Dockerfile

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder

WORKDIR /app

# 安装pnpm
RUN npm install -g pnpm

# 复制package.json
COPY package.json pnpm-lock.yaml ./

# 安装依赖
RUN pnpm install --frozen-lockfile

# 复制源码
COPY . .

# 构建
RUN pnpm build

# 运行阶段
FROM nginx:alpine

# 复制nginx配置
COPY nginx/nginx.conf /etc/nginx/nginx.conf

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 暴露端口
EXPOSE 80 443

# 启动nginx
CMD ["nginx", "-g", "daemon off;"]
```

### 2.5 Nginx配置

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;

    # HTTPS重定向
    server {
        listen 80;
        server_name yourdomain.com www.yourdomain.com;
        return 301 https://$server_name$request_uri;
    }

    # 主服务器配置
    server {
        listen 443 ssl http2;
        server_name yourdomain.com www.yourdomain.com;

        # SSL证书配置
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Strict-Transport-Security "max-age=31536000" always;

        # 前端静态文件
        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
            
            # 缓存策略
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # 后端API代理
        location /api/ {
            proxy_pass http://backend:8080/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 超时设置
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
            
            # 文件上传
            client_max_body_size 500M;
            client_body_buffer_size 128k;
        }

        # WebSocket支持（如果需要）
        location /ws/ {
            proxy_pass http://backend:8080/ws/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
```

### 2.6 部署命令

```bash
# 克隆项目
git clone https://github.com/yourusername/cloud-disk.git
cd cloud-disk

# 配置环境变量
cp .env.example .env
vim .env  # 修改配置

# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 更新服务
git pull
docker-compose build
docker-compose up -d
```

## 3. 传统部署

### 3.1 安装MySQL

```bash
# Ubuntu
sudo apt update
sudo apt install mysql-server

# 启动MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation

# 创建数据库和用户
mysql -u root -p
CREATE DATABASE cloud_disk CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'cloudisk'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON cloud_disk.* TO 'cloudisk'@'localhost';
FLUSH PRIVILEGES;

# 导入数据库
mysql -u cloudisk -p cloud_disk < init.sql
```

### 3.2 安装Redis

```bash
# Ubuntu
sudo apt update
sudo apt install redis-server

# 配置Redis
sudo vim /etc/redis/redis.conf
# 修改以下配置：
# requirepass your_redis_password
# bind 127.0.0.1

# 重启Redis
sudo systemctl restart redis
sudo systemctl enable redis
```

### 3.3 部署后端

```bash
# 安装Java 17
sudo apt install openjdk-17-jdk

# 克隆项目
git clone https://github.com/yourusername/cloud-disk-backend.git
cd cloud-disk-backend

# 配置application-prod.yml
vim src/main/resources/application-prod.yml

# 构建项目
./mvnw clean package -DskipTests

# 创建运行目录
sudo mkdir -p /opt/cloud-disk
sudo cp target/cloud-disk-backend.jar /opt/cloud-disk/

# 创建systemd服务
sudo vim /etc/systemd/system/cloud-disk.service
```

#### cloud-disk.service
```ini
[Unit]
Description=Cloud Disk Backend Service
After=syslog.target network.target mysql.service redis.service

[Service]
Type=simple
User=cloudisk
WorkingDirectory=/opt/cloud-disk
ExecStart=/usr/bin/java -Xms512m -Xmx2g -XX:+UseG1GC \
    -Dspring.profiles.active=prod \
    -Dfile.encoding=UTF-8 \
    -jar /opt/cloud-disk/cloud-disk-backend.jar
SuccessExitStatus=143
Restart=always
RestartSec=10

# 日志
StandardOutput=journal
StandardError=journal
SyslogIdentifier=cloud-disk

[Install]
WantedBy=multi-user.target
```

```bash
# 创建用户
sudo useradd -r -s /bin/false cloudisk
sudo chown -R cloudisk:cloudisk /opt/cloud-disk

# 启动服务
sudo systemctl daemon-reload
sudo systemctl start cloud-disk
sudo systemctl enable cloud-disk

# 查看状态
sudo systemctl status cloud-disk

# 查看日志
sudo journalctl -u cloud-disk -f
```

### 3.4 部署前端

```bash
# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install nodejs

# 安装pnpm
npm install -g pnpm

# 构建前端
git clone https://github.com/yourusername/cloud-disk-frontend.git
cd cloud-disk-frontend

# 安装依赖
pnpm install

# 修改环境变量
vim .env.production
# VITE_API_BASE_URL=https://yourdomain.com/api

# 构建
pnpm build

# 部署到nginx
sudo mkdir -p /var/www/cloud-disk
sudo cp -r dist/* /var/www/cloud-disk/
```

### 3.5 配置Nginx

```bash
# 安装Nginx
sudo apt install nginx

# 创建配置文件
sudo vim /etc/nginx/sites-available/cloud-disk
```

```nginx
server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    root /var/www/cloud-disk;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/cloud-disk /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
sudo systemctl enable nginx
```

## 4. 监控与日志

### 4.1 应用监控

#### 4.1.1 使用Spring Boot Actuator

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

#### 4.1.2 Prometheus监控

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'cloud-disk'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/api/actuator/prometheus'
```

#### 4.1.3 Grafana可视化

```bash
# 安装Grafana
sudo apt-get install -y software-properties-common
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
sudo apt-get update
sudo apt-get install grafana

# 启动Grafana
sudo systemctl start grafana-server
sudo systemctl enable grafana-server

# 访问: http://localhost:3000
# 默认账号: admin/admin
```

### 4.2 日志管理

#### 4.2.1 应用日志配置

```xml
<!-- logback-spring.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <springProperty scope="context" name="LOG_PATH" source="logging.file.path" defaultValue="./logs"/>
    
    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 文件输出 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/cloud-disk.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/cloud-disk.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 错误日志 -->
    <appender name="ERROR" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/error.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
        <appender-ref ref="ERROR"/>
    </root>
</configuration>
```

#### 4.2.2 日志收集（ELK Stack）

```yaml
# docker-compose-elk.yml
version: '3'
services:
  elasticsearch:
    image: elasticsearch:8.5.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"

  logstash:
    image: logstash:8.5.0
    volumes:
      - ./logstash/config:/usr/share/logstash/pipeline
    ports:
      - "5000:5000"
    depends_on:
      - elasticsearch

  kibana:
    image: kibana:8.5.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
```

## 5. 备份与恢复

### 5.1 数据库备份

#### 5.1.1 自动备份脚本

```bash
#!/bin/bash
# backup-mysql.sh

# 配置
DB_NAME="cloud_disk"
DB_USER="root"
DB_PASSWORD="your_password"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/cloud_disk_${DATE}.sql.gz"

# 创建备份目录
mkdir -p ${BACKUP_DIR}

# 备份数据库
mysqldump -u${DB_USER} -p${DB_PASSWORD} ${DB_NAME} | gzip > ${BACKUP_FILE}

# 删除30天前的备份
find ${BACKUP_DIR} -name "cloud_disk_*.sql.gz" -mtime +30 -delete

# 上传到远程存储（可选）
# rclone copy ${BACKUP_FILE} remote:backup/mysql/

echo "Backup completed: ${BACKUP_FILE}"
```

#### 5.1.2 配置定时任务

```bash
# 编辑crontab
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /opt/scripts/backup-mysql.sh >> /var/log/backup.log 2>&1
```

### 5.2 文件备份

```bash
#!/bin/bash
# backup-files.sh

SOURCE_DIR="/opt/cloud-disk/upload"
BACKUP_DIR="/backup/files"
DATE=$(date +%Y%m%d)

# 增量备份
rsync -av --delete ${SOURCE_DIR}/ ${BACKUP_DIR}/current/

# 创建快照
cp -al ${BACKUP_DIR}/current ${BACKUP_DIR}/snapshot_${DATE}

# 删除30天前的快照
find ${BACKUP_DIR} -name "snapshot_*" -mtime +30 -exec rm -rf {} \;
```

### 5.3 恢复数据

```bash
# 恢复数据库
gunzip < backup_file.sql.gz | mysql -u root -p cloud_disk

# 恢复文件
rsync -av /backup/files/snapshot_20250101/ /opt/cloud-disk/upload/
```

## 6. 性能优化

### 6.1 JVM调优

```bash
# 启动参数
java -Xms2g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/opt/cloud-disk/logs \
     -XX:+PrintGCDetails \
     -XX:+PrintGCDateStamps \
     -Xloggc:/opt/cloud-disk/logs/gc.log \
     -jar cloud-disk-backend.jar
```

### 6.2 MySQL优化

```ini
# my.cnf
[mysqld]
# InnoDB配置
innodb_buffer_pool_size = 2G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2

# 查询缓存
query_cache_type = 1
query_cache_size = 256M

# 连接数
max_connections = 500

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
```

### 6.3 Redis优化

```conf
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru

# AOF持久化
appendonly yes
appendfsync everysec

# 禁用危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
```

## 7. 故障排查

### 7.1 常见问题

#### 7.1.1 应用无法启动
```bash
# 查看日志
sudo journalctl -u cloud-disk -n 100

# 检查端口占用
sudo netstat -nltp | grep 8080

# 检查Java进程
ps aux | grep java
```

#### 7.1.2 数据库连接失败
```bash
# 测试数据库连接
mysql -h localhost -u cloudisk -p cloud_disk

# 检查MySQL状态
sudo systemctl status mysql

# 查看MySQL日志
sudo tail -f /var/log/mysql/error.log
```

#### 7.1.3 Redis连接失败
```bash
# 测试Redis连接
redis-cli -a your_password ping

# 检查Redis状态
sudo systemctl status redis

# 查看Redis日志
sudo tail -f /var/log/redis/redis-server.log
```

### 7.2 性能问题

#### 7.2.1 CPU使用率高
```bash
# 查看进程CPU使用
top -p $(pgrep java)

# 获取线程堆栈
jstack $(pgrep java) > thread_dump.txt

# 分析GC情况
jstat -gcutil $(pgrep java) 1000
```

#### 7.2.2 内存泄漏
```bash
# 生成堆转储
jmap -dump:format=b,file=heap_dump.hprof $(pgrep java)

# 使用MAT分析（Eclipse Memory Analyzer）
```

### 7.3 监控告警

```bash
# 磁盘空间监控
df -h

# 内存使用监控
free -h

# 网络连接监控
netstat -an | grep ESTABLISHED | wc -l
```

## 8. 升级维护

### 8.1 版本升级

```bash
# 1. 备份数据
./backup-all.sh

# 2. 停止服务
sudo systemctl stop cloud-disk
docker-compose down

# 3. 更新代码
git pull origin main

# 4. 数据库迁移
./migration.sh

# 5. 重新构建
docker-compose build

# 6. 启动服务
docker-compose up -d
sudo systemctl start cloud-disk

# 7. 验证
curl http://localhost:8080/api/health
```

### 8.2 维护窗口

```nginx
# 维护页面
server {
    listen 80;
    server_name yourdomain.com;
    
    location / {
        return 503;
    }
    
    error_page 503 @maintenance;
    location @maintenance {
        root /var/www/maintenance;
        rewrite ^(.*)$ /maintenance.html break;
    }
}
```

## 9. 安全加固

### 9.1 系统安全

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 配置防火墙
sudo ufw enable
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 禁用root登录
sudo vim /etc/ssh/sshd_config
# PermitRootLogin no
sudo systemctl restart sshd

# 安装fail2ban
sudo apt install fail2ban
```

### 9.2 应用安全

```yaml
# application-prod.yml安全配置
spring:
  security:
    require-ssl: true
  
server:
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: ${SSL_PASSWORD}
    key-store-type: PKCS12
```

## 10. 运维工具脚本

### 10.1 健康检查脚本

```bash
#!/bin/bash
# health-check.sh

API_URL="http://localhost:8080/api/health"
MAX_RETRIES=3
RETRY_INTERVAL=5

for i in $(seq 1 $MAX_RETRIES); do
    response=$(curl -s -o /dev/null -w "%{http_code}" $API_URL)
    
    if [ $response -eq 200 ]; then
        echo "Health check passed"
        exit 0
    fi
    
    echo "Health check failed (attempt $i/$MAX_RETRIES)"
    sleep $RETRY_INTERVAL
done

echo "Health check failed after $MAX_RETRIES attempts"
exit 1
```

### 10.2 日志清理脚本

```bash
#!/bin/bash
# cleanup-logs.sh

LOG_DIR="/opt/cloud-disk/logs"
DAYS_TO_KEEP=30

# 清理旧日志
find ${LOG_DIR} -name "*.log.*" -mtime +${DAYS_TO_KEEP} -delete

# 清理空日志
find ${LOG_DIR} -type f -size 0 -delete

echo "Log cleanup completed"
```

